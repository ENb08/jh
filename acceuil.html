<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SuperMarket Pro</title>
    <meta name="description" content="Tableau de bord SuperMarket Pro ‚Äî ventes, stock et rapports.">
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style_acceuil.css">
    <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
    <style>
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-online {
            background: #10b981;
            color: white;
        }
        .status-offline {
            background: #ef4444;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Indicateur de connexion -->
    <div id="connection-status" class="connection-status status-online">üü¢ En ligne</div>
    <div class="app" id="app">
        <aside class="sidebar" id="sidebar" aria-label="Navigation principale">
            <div class="brand" role="img" aria-hidden="true">
                <div class="logo"><img src="assets/img/logo.png" alt="Logo SuperMarket Pro"></div>
                <div>
                    <h2>SuperMarket Pro</h2>
                    <div style="font-size:12px;color:var(--muted)">Gestion & ventes</div>
                </div>
            </div>

            <nav class="menu" aria-label="Menu principal">
                <a href="index.html" class="menu-item active" aria-current="page"><i class="fas fa-home"></i> Tableau de Bord</a>
                <a href="caisse.html" class="menu-item"><i class="fas fa-cash-register"></i> Vente / Caisse</a>
                <a href="stock.html" class="menu-item"><i class="fas fa-box"></i> Gestion Stock</a>
                <a href="users.html" class="menu-item"><i class="fas fa-users"></i> Clients</a>
                <a href="tresoreri.html" class="menu-item"><i class="fas fa-chart-line"></i> Rapports</a>
                <a href="#" class="menu-item" id="btn-logout" style="color: #e74c3c; margin-top: 20px;"><i class="fas fa-sign-out-alt"></i> D√©connexion</a>
            </nav>

            <div class="footer-small">¬© <span id="year"></span> SuperMarket Pro</div>
        </aside>

        <div class="overlay" id="overlay" tabindex="-1" hidden></div>

        <main class="main-content" id="main">
            <header class="topbar" role="banner">
                <div class="left">
                    <button class="btn-ghost" id="menuToggle" aria-label="Ouvrir le menu" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h3 style="margin:0">Tableau de Bord</h3>
                </div>

                <div style="display:flex;gap:12px;align-items:center">
                    <input class="search" type="search" placeholder="Rechercher une vente / produit..." aria-label="Rechercher">
                    <div class="user-info" aria-hidden="false">
                        <div style="text-align:right;margin-right:8px">
                            <div style="font-weight:600" id="userName">‚Äî</div>
                            <div style="font-size:12px;color:var(--muted)" id="currentDate">‚Äî</div>
                        </div>
                        <div class="avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
                    </div>
                </div>
            </header>

            <section class="cards-container" aria-label="Indicateurs">
                <div class="card" style="border-left-color: #2563eb;">
                    <h3>Ventes du Jour</h3>
                    <p id="ventesJour">‚Äî</p>
                    <div style="margin-top:8px;font-size:13px;color:var(--muted)" id="ventesCount">‚Äî</div>
                </div>

                <div class="card" style="border-left-color: #10b981;">
                    <h3>Clients</h3>
                    <p id="nbClients">‚Äî</p>
                    <div style="margin-top:8px;font-size:13px;color:var(--muted)">Transactions du jour</div>
                </div>

                <div class="card" style="border-left-color: #f59e0b;">
                    <h3>Alertes Stock</h3>
                    <p id="nbAlerts">‚Äî</p>
                    <div style="margin-top:8px;font-size:13px;color:var(--muted)">V√©rifier approvisionnement</div>
                </div>
            </section>

            <h4>Derni√®res Ventes</h4>
            <div class="table-wrap" role="region" aria-labelledby="recent-sales">
                <table aria-describedby="recent-sales">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date/Heure</th>
                            <th>Montant</th>
                            <th>Articles</th>
                            <th>Paiement</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="ventesTable">
                        <tr>
                            <td colspan="6" style="text-align:center;padding:20px">Chargement...</td>
                        </tr>
                            <td>#V1022</td>
                            <td>Jean Dupont</td>
                            <td>120.50 ‚Ç¨</td>
                            <td>10:30</td>
                            <td><span class="badge warn">En attente</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Dashboard avec donn√©es de la base
        (async function(){
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            const overlay = document.getElementById('overlay');
            const yearEl = document.getElementById('year');
            const dateEl = document.getElementById('currentDate');

            // Set year and formatted date
            const now = new Date();
            yearEl.textContent = now.getFullYear();
            dateEl.textContent = now.toLocaleString('fr-FR', {weekday:'short', day:'numeric', month:'short'});

            function openSidebar(){
                sidebar.classList.add('open');
                overlay.hidden = false;
                overlay.classList.add('show');
                menuToggle.setAttribute('aria-expanded','true');
            }
            function closeSidebar(){
                sidebar.classList.remove('open');
                overlay.hidden = true;
                overlay.classList.remove('show');
                menuToggle.setAttribute('aria-expanded','false');
            }

            menuToggle.addEventListener('click', () => {
                if (!sidebar.classList.contains('open')) openSidebar(); else closeSidebar();
            });

            overlay.addEventListener('click', closeSidebar);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSidebar();
            });

            // D√©connexion
            document.getElementById('btn-logout').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                    try {
                        localStorage.clear();
                        sessionStorage.clear();
                        await fetch('assets/Api/logout.php', {method: 'POST'});
                    } catch (error) {
                        console.error('Erreur d√©connexion:', error);
                    } finally {
                        window.location.href = 'index.html';
                    }
                }
            });

            // Charger les donn√©es du dashboard
            try {
                const response = await fetch('assets/Api/getDashboard.php');
                const data = await response.json();

                if (data.success) {
                    // Afficher le nom de l'utilisateur
                    document.getElementById('userName').textContent = data.user.name;

                    // Afficher les statistiques
                    const stats = data.stats;
                    const ventesJour = stats.ventes_jour;
                    
                    // Format des ventes
                    let ventesText = '';
                    if (ventesJour.total_cdf > 0) {
                        ventesText += Math.round(ventesJour.total_cdf).toLocaleString('fr-FR') + ' FC';
                    }
                    if (ventesJour.total_usd > 0) {
                        if (ventesText) ventesText += ' + ';
                        ventesText += '$' + ventesJour.total_usd.toFixed(2);
                    }
                    if (!ventesText) ventesText = '0 FC';
                    
                    document.getElementById('ventesJour').textContent = ventesText;
                    document.getElementById('ventesCount').textContent = ventesJour.nb_ventes + ' vente(s)';
                    document.getElementById('nbClients').textContent = stats.nb_clients;
                    document.getElementById('nbAlerts').textContent = stats.nb_alerts_stock + ' Produit(s)';

                    // Afficher les ventes r√©centes
                    const tbody = document.getElementById('ventesTable');
                    tbody.innerHTML = '';

                    if (data.recent_ventes.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Aucune vente enregistr√©e</td></tr>';
                    } else {
                        data.recent_ventes.forEach(vente => {
                            const date = new Date(vente.date_vente);
                            const dateStr = date.toLocaleString('fr-FR', {
                                day: '2-digit',
                                month: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const montant = vente.devise === 'CDF' 
                                ? Math.round(vente.total).toLocaleString('fr-FR') + ' FC'
                                : '$' + parseFloat(vente.total).toFixed(2);

                            const statusClass = vente.statut === 'completed' ? 'success' : 'warn';
                            const statusText = vente.statut === 'completed' ? 'Pay√©' : 'En attente';

                            const tr = document.createElement('tr');
                            tr.dataset.id = vente.id_vente;
                            tr.tabIndex = 0;
                            tr.innerHTML = `
                                <td>#V${vente.id_vente}</td>
                                <td>${dateStr}</td>
                                <td>${montant}</td>
                                <td>${vente.nb_articles || 0}</td>
                                <td>${vente.mode_paiement.toUpperCase()}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                            `;

                            tr.addEventListener('click', () => {
                                alert('Ouvrir d√©tail de la vente #V' + vente.id_vente);
                            });

                            tbody.appendChild(tr);
                        });
                    }
                } else {
                    console.error('Erreur:', data.message);
                    if (data.message.includes('non connect√©')) {
                        alert('Session expir√©e. Reconnexion n√©cessaire.');
                        window.location.href = 'index.html';
                    }
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                alert('Erreur de chargement des donn√©es');
            }
        })();
    </script>
    <script src="assets/js/offline-manager.js"></script>
    <script>
        // Enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('‚úÖ Service Worker enregistr√©:', reg.scope))
                .catch(err => console.error('‚ùå Erreur SW:', err));
        }
    </script>
</body>

</html>